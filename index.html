<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- PWA meta for iOS -->
	<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="default">
	<meta name="apple-mobile-web-app-title" content="TaskFlow Pro">
	<link rel="apple-touch-icon" href="icons/icon-192.png">

<!-- Web App Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Theme Color (Android + some iOS cases) -->
<meta name="theme-color" content="#4f46e5">

    <title>TaskFlow Pro - Professional Freelance Task Manager</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; min-height: 100vh; color: #1f2937; }
        .container { max-width: 414px; margin: 0 auto; background: white; min-height: 100vh; position: relative; box-shadow: 0 0 30px rgba(0,0,0,0.1); }
        

        .sync-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: all 0.3s ease; }
        .sync-btn:hover { background: rgba(255,255,255,0.2); }
        .sync-status { display: flex; align-items: center; gap: 4px; font-size: 11px; color: rgba(255,255,255,0.8); margin-top: 4px; }
        .sync-indicator { width: 8px; height: 8px; border-radius: 50%; background: #10b981; }
        .sync-indicator.syncing { background: #f59e0b; animation: pulse 1s infinite; }
        .sync-indicator.offline { background: #dc2626; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .header { background: #4f46e5; color: white; padding: 24px; position: relative; }
        .header-content { display: flex; justify-content: space-between; align-items: center; }
        .header-text { text-align: left; }
        .header-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 16px; }
        .nav-tabs { display: flex; background: white; border-bottom: 1px solid #e5e7eb; }
        .nav-tab { flex: 1; padding: 16px; text-align: center; background: none; border: none; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .nav-tab.active { color: #4f46e5; }
        .nav-tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: #4f46e5; border-radius: 3px 3px 0 0; }
        .content { padding: 16px; min-height: calc(100vh - 200px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .dashboard-section { margin-bottom: 32px; }
        .section-title { font-size: 20px; font-weight: 700; color: #1f2937; margin-bottom: 0; display: flex; align-items: center; gap: 8px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; margin-bottom: 16px; border-radius: 8px; transition: background-color 0.2s ease; }
        .section-header:hover { background-color: #f9fafb; padding-left: 8px; padding-right: 8px; }
        .section-content { display: none; margin-bottom: 16px; }
        .section-content.expanded { display: block; }
        
        .task-item { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #4f46e5; }
        .task-item.urgent { border-left-color: #dc2626; }
        .task-item.medium { border-left-color: #f59e0b; }
        .task-title { font-weight: 600; color: #1f2937; margin-bottom: 4px; }
        .task-meta { font-size: 12px; color: #6b7280; }
        
        /* Responsive Calendar Styles */
        .calendar { background: white; border-radius: 16px; padding: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 100%; max-width: 100%; overflow: hidden; margin: 0 auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .calendar-nav { background: none; border: none; font-size: 18px; color: #4f46e5; cursor: pointer; padding: 8px; min-width: 44px; display: flex; align-items: center; justify-content: center; }
        .calendar-month { font-weight: 600; color: #1f2937; font-size: 16px; text-align: center; flex: 1; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; width: 100%; }
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 10px; border-radius: 4px; position: relative; min-height: 32px; background: white; color: #1f2937; border: 1px solid #e5e7eb; transition: all 0.2s ease; cursor: pointer; }
        .calendar-day.header { font-weight: 600; color: white; font-size: 10px; background: #4f46e5; border: 1px solid #4338ca; cursor: default; }
        .calendar-day.today { background: #4f46e5; color: white; border: 1px solid #4338ca; }
        .calendar-day.other-month { color: #9ca3af; background: #f9fafb; }
        .calendar-day.has-task::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 3px; height: 3px; background: #f59e0b; border-radius: 50%; }
        .calendar-day:not(.header):hover { background: #f0f4ff; border-color: #4f46e5; }
        .calendar-tooltip { position: absolute; background: rgba(0, 0, 0, 0.9); color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 1000; pointer-events: none; opacity: 0; transition: opacity 0.2s ease; max-width: 200px; white-space: normal; line-height: 1.4; }
        .calendar-tooltip.show { opacity: 1; }
        
        .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .add-btn { background: #4f46e5; color: white; border: none; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
        .add-btn:hover { background: #4338ca; transform: translateY(-1px); }
        .job-tabs { display: flex; overflow-x: auto; gap: 8px; margin-bottom: 24px; padding-bottom: 8px; }
        .job-tab { background: #f3f4f6; border: none; padding: 12px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; white-space: nowrap; transition: all 0.3s ease; }
        .job-tab.active { background: #4f46e5; color: white; }
        .job-content { display: none; }
        .job-content.active { display: block; }
        
        .job-info { background: white; border-radius: 16px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .job-name { font-size: 24px; font-weight: 700; color: #1f2937; margin-bottom: 12px; }
        .job-description { color: #4b5563; line-height: 1.6; margin-bottom: 16px; }
        .job-notes { background: #f9fafb; padding: 16px; border-radius: 12px; border-left: 4px solid #4f46e5; }
        .job-notes-title { font-weight: 600; color: #1f2937; margin-bottom: 8px; }
        .view-toggle { display: flex; gap: 8px; margin-bottom: 20px; }
        .view-btn { background: #f3f4f6; border: none; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; transition: all 0.3s ease; }
        .view-btn.active { background: #4f46e5; color: white; }
        .projects-grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
        .projects-banner { display: none; gap: 16px; }
        .projects-banner.active { display: flex; flex-direction: column; }
        
        .project-card { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 4px solid #10b981; position: relative; }
        .project-card.priority-high { border-left-color: #dc2626; }
        .project-card.priority-medium { border-left-color: #f59e0b; }
        .project-card.priority-low { border-left-color: #10b981; }
        .project-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .project-title { font-size: 18px; font-weight: 700; color: #1f2937; flex: 1; }
        .project-status { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-left: 12px; }
        .status-active { background: #d1fae5; color: #065f46; }
        .status-pending { background: #fef3c7; color: #92400e; }
        .status-completed { background: #e5e7eb; color: #374151; }
        .status-on-hold { background: #fee2e2; color: #dc2626; }
        .project-meta { display: flex; gap: 16px; font-size: 12px; color: #6b7280; margin-bottom: 12px; flex-wrap: wrap; }
        .project-meta-item { display: flex; align-items: center; gap: 4px; }
        .priority-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 10px; font-weight: 600; text-transform: uppercase; }
        .priority-high { background: #fee2e2; color: #dc2626; }
        .priority-medium { background: #fef3c7; color: #d97706; }
        .priority-low { background: #d1fae5; color: #065f46; }
        .project-description { color: #4b5563; line-height: 1.5; margin-bottom: 16px; }
        .project-notes { background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 16px; border-left: 3px solid #4f46e5; }
        .project-notes-title { font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 6px; }
        .project-notes-content { font-size: 14px; color: #4b5563; line-height: 1.4; }
        .progress-bar { background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden; margin-bottom: 8px; }
        .progress-fill { background: #10b981; height: 100%; transition: width 0.3s ease; }
        .progress-text { font-size: 12px; color: #6b7280; text-align: right; }
        
        .tasks-banner { background: #f3f4f6; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; cursor: pointer; transition: all 0.3s ease; border: 2px solid transparent; }
        .tasks-banner:hover { background: #e5e7eb; border-color: #4f46e5; }
        .tasks-banner-content { display: flex; justify-content: space-between; align-items: center; }
        .tasks-controls { display: flex; align-items: center; gap: 8px; }
        .tasks-info { display: flex; align-items: center; gap: 12px; }
        .tasks-count { font-weight: 600; color: #1f2937; }
        .tasks-progress { font-size: 12px; color: #6b7280; }
        .expand-icon { font-size: 16px; color: #6b7280; transition: transform 0.3s ease; }
        .tasks-banner.expanded .expand-icon { transform: rotate(180deg); }
        .tasks-list { display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; }
        .tasks-list.expanded { display: block; }
        .task-item-mini { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
        .task-item-mini:last-child { border-bottom: none; }
        .task-name { font-size: 14px; color: #374151; }
        .task-status-mini { font-size: 12px; padding: 2px 8px; border-radius: 12px; font-weight: 600; }
        .task-completed { background: #d1fae5; color: #065f46; }
        .task-not-started { background: #f3f4f6; color: #374151; }
        .task-in-progress { background: #dbeafe; color: #1d4ed8; }
        .task-cancelled { background: #fee2e2; color: #dc2626; }
        
        .task-card { background: white; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #4f46e5; }
        .task-card.priority-high { border-left-color: #dc2626; }
        .task-card.priority-medium { border-left-color: #f59e0b; }
        .task-card.priority-low { border-left-color: #10b981; }
        .task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .task-name-main { font-size: 16px; font-weight: 600; color: #1f2937; flex: 1; }
        .task-meta-info { display: flex; gap: 12px; font-size: 12px; color: #6b7280; margin-bottom: 8px; flex-wrap: wrap; }
        .task-description { color: #4b5563; line-height: 1.5; margin-bottom: 12px; font-size: 14px; }
        .task-actions { display: flex; gap: 8px; margin-top: 12px; }
        .details-btn { background: #f3f4f6; border: none; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #374151; cursor: pointer; transition: all 0.3s ease; }
        .details-btn:hover { background: #e5e7eb; }
        .task-detail-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .task-detail-modal.active { display: flex; }
        .task-detail-content { background: white; border-radius: 16px; padding: 24px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
        .modal-title { font-size: 20px; font-weight: 700; color: #1f2937; }
        .close-btn { background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer; padding: 4px; }
        .modal-section { margin-bottom: 20px; }
        .modal-section-title { font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px; }
        .modal-section-content { color: #4b5563; line-height: 1.5; }
        
        .file-attachment { background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .file-attachment:hover { border-color: #667eea; background: #f0f4ff; }
        .file-upload-area { background: #f9fafb; border: 2px dashed #d1d5db; border-radius: 12px; padding: 24px; text-align: center; cursor: pointer; transition: all 0.3s ease; margin-bottom: 16px; }
        .file-upload-area:hover { border-color: #667eea; background: #f0f4ff; }
        .file-upload-area.dragover { border-color: #667eea; background: #e0e7ff; }
        .uploaded-files { margin-top: 16px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 8px; }
        .file-info { display: flex; align-items: center; gap: 12px; flex: 1; }
        .file-icon { font-size: 24px; }
        .file-details { flex: 1; }
        .file-name { font-weight: 600; color: #1f2937; margin-bottom: 2px; cursor: pointer; }
        .file-name:hover { color: #4f46e5; text-decoration: underline; }
        .file-size { font-size: 12px; color: #6b7280; }
        .file-actions { display: flex; gap: 8px; }
        .file-action-btn { background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s ease; }
        .file-action-btn:hover { background: #f3f4f6; color: #374151; }
        .file-action-btn.delete:hover { background: #fee2e2; color: #dc2626; }
        .file-action-btn.view { color: #4f46e5; }
        .file-action-btn.view:hover { background: #f0f4ff; color: #4338ca; }
        .file-action-btn.download { color: #10b981; }
        .file-action-btn.download:hover { background: #f0fdf4; color: #059669; }
        .media-preview { max-width: 100%; border-radius: 8px; margin-top: 8px; }
        .media-preview img { max-width: 100%; height: auto; border-radius: 8px; }
        .media-preview video, .media-preview audio { width: 100%; border-radius: 8px; }
        .file-type-image { color: #10b981; }
        .file-type-video { color: #3b82f6; }
        .file-type-audio { color: #8b5cf6; }
        .file-type-document { color: #f59e0b; }
        .file-type-other { color: #6b7280; }
        .subtasks-section { margin-top: 20px; }
        .subtask-item { background: #f9fafb; border-radius: 8px; padding: 12px; margin-bottom: 8px; border-left: 3px solid #4f46e5; }
        .subtask-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .subtask-name { font-weight: 600; color: #374151; font-size: 14px; }
        .subtask-meta { font-size: 11px; color: #6b7280; }
        .add-subtask-btn { background: #4f46e5; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 12px; }
        
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; font-family: inherit; transition: border-color 0.3s ease; }
        .form-input:focus, .form-textarea:focus, .form-select:focus { outline: none; border-color: #4f46e5; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 20px; border-top: 1px solid #e5e7eb; }
        .cancel-btn, .save-btn, .delete-btn { padding: 10px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s ease; }
        .cancel-btn { background: #f3f4f6; color: #374151; }
        .cancel-btn:hover { background: #e5e7eb; }
        .save-btn { background: #4f46e5; color: white; }
        .save-btn:hover { background: #4338ca; }
        .delete-btn { background: #dc2626; color: white; }
        .delete-btn:hover { background: #b91c1c; }
        .delete-modal-content { background: white; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%; position: relative; }
        .delete-message { font-size: 16px; color: #374151; margin-bottom: 8px; }
        .delete-warning { font-size: 14px; color: #dc2626; font-weight: 500; }
        
        .context-menu { position: fixed; background: white; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); border: 1px solid #e5e7eb; padding: 4px 0; z-index: 2000; display: none; min-width: 120px; }
        .context-menu-item { padding: 8px 16px; font-size: 14px; color: #374151; cursor: pointer; transition: background-color 0.2s ease; border: none; background: none; width: 100%; text-align: left; }
        .context-menu-item:hover { background: #f3f4f6; }
        .context-menu-item.delete { color: #dc2626; }
        .context-menu-item.delete:hover { background: #fee2e2; }
        .menu-btn { background: none; border: none; font-size: 16px; color: #6b7280; cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: all 0.2s ease; line-height: 1; font-weight: bold; }
        .menu-btn:hover { background: #f3f4f6; color: #374151; }
        .menu-btn:active { background: #e5e7eb; }
        .editable { cursor: text; transition: all 0.2s ease; border-radius: 4px; padding: 2px 4px; margin: -2px -4px; }
        .editable:hover { background: #f9fafb; }
        .editable:focus { outline: 2px solid #667eea; background: white; }
        .inline-editable { cursor: pointer; transition: all 0.2s ease; border-radius: 4px; padding: 2px 4px; margin: -2px -4px; position: relative; }
        .inline-editable:hover { background: #f0f4ff; box-shadow: 0 0 0 1px #4f46e5; }
        .inline-editable.editing { background: white; box-shadow: 0 0 0 2px #4f46e5; }
        .inline-select { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: white; border: 2px solid #4f46e5; border-radius: 4px; font-size: inherit; font-family: inherit; color: inherit; z-index: 10; }
        .inline-input { background: transparent; border: none; outline: none; width: 100%; font-size: inherit; font-family: inherit; color: inherit; }
        .banner-card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 4px solid #10b981; margin-bottom: 16px; }
        .banner-card.priority-high { border-left-color: #dc2626; }
        .banner-card.priority-medium { border-left-color: #f59e0b; }
        .banner-card.priority-low { border-left-color: #10b981; }
        .banner-main { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .banner-left { flex: 1; }
        .banner-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .note-card { background: white; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-left: 4px solid #f59e0b; }
        .note-title { font-size: 18px; font-weight: 700; color: #1f2937; margin-bottom: 8px; }
        .note-meta { font-size: 12px; color: #6b7280; margin-bottom: 12px; }
        .note-content { color: #4b5563; line-height: 1.6; }
        .empty-state { text-align: center; padding: 40px 20px; color: #6b7280; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .loading { text-align: center; padding: 20px; color: #6b7280; }
        
        /* File Viewer Modal */
        .file-viewer-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
        .file-viewer-modal.active { display: flex; }
        .file-viewer-content { background: white; border-radius: 16px; padding: 24px; max-width: 90vw; max-height: 90vh; overflow: auto; position: relative; }
        .file-viewer-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e5e7eb; }
        .file-viewer-title { font-size: 18px; font-weight: 600; color: #1f2937; }
        .file-viewer-media { text-align: center; }
        .file-viewer-media img { max-width: 100%; max-height: 70vh; border-radius: 8px; }
        .file-viewer-media video, .file-viewer-media audio { max-width: 100%; border-radius: 8px; }
        
        /* Mobile Responsive Improvements */
        @media (max-width: 480px) {
            .content { padding: 12px; }
            .calendar { padding: 8px; }
            .calendar-day { min-height: 28px; font-size: 9px; }
            .calendar-day.header { font-size: 9px; }
            .calendar-month { font-size: 14px; }
            .calendar-nav { font-size: 16px; padding: 6px; }
            .dashboard-section { margin-bottom: 24px; }
            .section-title { font-size: 18px; }
        }
        
        @media (min-width: 768px) { 
            .container { max-width: 768px; margin-top: 40px; border-radius: 20px; min-height: calc(100vh - 80px); } 
            .content { padding: 32px; } 
            .projects-grid { grid-template-columns: repeat(2, 1fr); }
            .calendar { padding: 20px; }
            .calendar-day { min-height: 40px; font-size: 12px; }
            .calendar-day.header { font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">

        
        <div class="header">
            <div class="header-content">
                <div class="header-text">
                    <h1>TaskFlow Pro</h1>
                    <p>Professional freelance project management</p>
                </div>
                <div class="header-actions">
                    <div class="sync-status" id="sync-status">
                        <div class="sync-indicator offline" id="sync-indicator"></div>
                        <span id="sync-text">Offline</span>
                    </div>
                    <button class="sync-btn" id="sync-btn" onclick="testSync()">Test Sync</button>
                </div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchMainTab('dashboard')">Dashboard</button>
            <button class="nav-tab" onclick="switchMainTab('progress')">Progress</button>
            <button class="nav-tab" onclick="switchMainTab('notes')">Notes</button>
        </div>
        
        <div class="content">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="dashboard-section">
                    <div class="section-header" onclick="toggleDashboardSection(this)">
                        <h2 class="section-title">📅 Due Today</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content expanded" id="due-today-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">📅</div>
                            <div>No tasks due today. Great job staying on top of things!</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <div class="section-header" onclick="toggleDashboardSection(this)">
                        <h2 class="section-title">📋 This Week</h2>
                        <span class="expand-icon">▼</span>
                    </div>
                    <div class="section-content expanded" id="this-week-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <div>No tasks due this week. Time to plan ahead!</div>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-section">
                    <h2 class="section-title" id="calendar-section-title">🗓️ Calendar</h2>
                    <div class="calendar">
                        <div class="calendar-header">
                            <button class="calendar-nav" onclick="changeMonth(-1)">‹</button>
                            <div class="calendar-month" id="calendar-month-display">Loading...</div>
                            <button class="calendar-nav" onclick="changeMonth(1)">›</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Tab -->
            <div id="progress-tab" class="tab-content">
                <div class="progress-header">
                    <h2 class="section-title">💼 Jobs & Projects</h2>
                    <button class="add-btn" onclick="addJob()">+ Add Job</button>
                </div>
                
                <div class="job-tabs" id="job-tabs-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">💼</div>
                        <div>No jobs yet. Click "Add Job" to get started!</div>
                    </div>
                </div>
                
                <div id="job-content-container">
                    <!-- Job contents will be dynamically added here -->
                </div>
            </div>
            
            <!-- Notes Tab -->
            <div id="notes-tab" class="tab-content">
                <div class="progress-header">
                    <h2 class="section-title">📝 Notes</h2>
                    <button class="add-btn" onclick="addNote()">+ Add Note</button>
                </div>
                
                <div id="notes-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div>No notes yet. Click "Add Note" to start taking notes!</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Task Detail Modal -->
    <div id="task-detail-modal" class="task-detail-modal">
        <div class="task-detail-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-task-title">Task Details</div>
                <button class="close-btn" onclick="closeTaskDetails()">×</button>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Description</div>
                <div class="modal-section-content" id="modal-task-description">
                    Task description will appear here...
                </div>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Status & Priority</div>
                <div class="modal-section-content" id="modal-task-status">
                    <div style="display: flex; gap: 12px; margin-bottom: 8px;">
                        <span id="modal-task-status-badge">Status</span>
                        <span id="modal-task-priority-badge">Priority</span>
                    </div>
                    <div style="font-size: 12px; color: #6b7280;" id="modal-task-due">Due date</div>
                </div>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">📝 Notes</div>
                <div class="modal-section-content" id="modal-task-notes">
                    Task-specific notes and comments will appear here...
                </div>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">📎 File Attachments</div>
                <div class="file-attachment" onclick="attachFile()">
                    <div style="color: #6b7280; font-size: 14px;">
                        📁 Click to attach files<br>
                        <small>Drag and drop files here or click to browse</small>
                    </div>
                </div>
            </div>
            
            <div class="modal-section subtasks-section">
                <div class="modal-section-title">📋 Sub-tasks</div>
                <div id="subtasks-container">
                    <!-- Subtasks will be populated here -->
                </div>
                <button class="add-subtask-btn" onclick="addSubtask()">+ Add Sub-task</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div id="add-task-modal" class="task-detail-modal">
        <div class="task-detail-content">
            <div class="modal-header">
                <div class="modal-title" id="task-modal-title">Add New Task</div>
                <button class="close-btn" onclick="closeAddTask()">×</button>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Task Name</div>
                <input type="text" id="new-task-name" class="form-input" placeholder="Enter task name...">
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Description</div>
                <textarea id="new-task-description" class="form-textarea" placeholder="Enter task description..."></textarea>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Status</div>
                <select id="new-task-status" class="form-select">
                    <option value="not-started">Not Started</option>
                    <option value="in-progress">In Progress</option>
                    <option value="completed">Completed</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Priority</div>
                <select id="new-task-priority" class="form-select">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Due Date</div>
                <input type="date" id="new-task-due" class="form-input">
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Notes</div>
                <textarea id="new-task-notes" class="form-textarea" placeholder="Add any notes or comments..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddTask()">Cancel</button>
                <button class="save-btn" id="task-save-btn" onclick="saveNewTask()">Create Task</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Note Modal -->
    <div id="add-note-modal" class="task-detail-modal">
        <div class="task-detail-content">
            <div class="modal-header">
                <div class="modal-title" id="note-modal-title">Add New Note</div>
                <button class="close-btn" onclick="closeAddNote()">×</button>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Note Title</div>
                <input type="text" id="new-note-title" class="form-input" placeholder="Enter note title...">
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Content</div>
                <textarea id="new-note-content" class="form-textarea" placeholder="Enter note content..." style="min-height: 120px;"></textarea>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">📎 Attachments</div>
                <div class="file-upload-area" onclick="triggerFileUpload()" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <div style="color: #6b7280; font-size: 14px;">
                        📁 Click to upload files or drag and drop<br>
                        <small>Images, videos, audio, documents supported</small>
                    </div>
                </div>
                <input type="file" id="note-file-input" multiple accept="*/*" style="display: none;" onchange="handleFileSelect(event)">
                <div id="note-uploaded-files" class="uploaded-files"></div>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddNote()">Cancel</button>
                <button class="save-btn" id="note-save-btn" onclick="saveNewNote()">Create Note</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="task-detail-modal">
        <div class="delete-modal-content">
            <div class="modal-header">
                <div class="modal-title">⚠️ Confirm Delete</div>
                <button class="close-btn" onclick="closeDeleteModal()">×</button>
            </div>
            
            <div class="modal-section">
                <div class="delete-message" id="delete-message">
                    Are you sure you want to delete this item?
                </div>
                <div class="delete-warning">
                    This action cannot be undone.
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeDeleteModal()">Cancel</button>
                <button class="delete-btn" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Job Modal -->
    <div id="add-job-modal" class="task-detail-modal">
        <div class="task-detail-content">
            <div class="modal-header">
                <div class="modal-title" id="job-modal-title">Add New Job</div>
                <button class="close-btn" onclick="closeAddJob()">×</button>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Job Name</div>
                <input type="text" id="new-job-name" class="form-input" placeholder="Enter job name...">
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Description</div>
                <textarea id="new-job-description" class="form-textarea" placeholder="Enter job description..."></textarea>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Notes</div>
                <textarea id="new-job-notes" class="form-textarea" placeholder="Add any notes or comments..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddJob()">Cancel</button>
                <button class="save-btn" id="job-save-btn" onclick="saveNewJob()">Create Job</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Project Modal -->
    <div id="add-project-modal" class="task-detail-modal">
        <div class="task-detail-content">
            <div class="modal-header">
                <div class="modal-title" id="project-modal-title">Add New Project</div>
                <button class="close-btn" onclick="closeAddProject()">×</button>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Project Title</div>
                <input type="text" id="new-project-title" class="form-input" placeholder="Enter project title...">
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Description</div>
                <textarea id="new-project-description" class="form-textarea" placeholder="Enter project description..."></textarea>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Status</div>
                <select id="new-project-status" class="form-select">
                    <option value="active">Active</option>
                    <option value="pending">Pending</option>
                    <option value="completed">Completed</option>
                    <option value="on-hold">On Hold</option>
                </select>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Priority</div>
                <select id="new-project-priority" class="form-select">
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Due Date</div>
                <input type="date" id="new-project-due" class="form-input">
            </div>
            
            <div class="modal-section">
                <div class="modal-section-title">Notes</div>
                <textarea id="new-project-notes" class="form-textarea" placeholder="Add project notes..."></textarea>
            </div>
            
            <div class="modal-actions">
                <button class="cancel-btn" onclick="closeAddProject()">Cancel</button>
                <button class="save-btn" id="project-save-btn" onclick="saveNewProject()">Create Project</button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div id="file-viewer-modal" class="file-viewer-modal">
        <div class="file-viewer-content">
            <div class="file-viewer-header">
                <div class="file-viewer-title" id="file-viewer-title">File Viewer</div>
                <button class="close-btn" onclick="closeFileViewer()">×</button>
            </div>
            
            <div class="file-viewer-media" id="file-viewer-media">
                <!-- File content will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Authentication removed - auto-sync enabled -->

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
        <button class="context-menu-item" onclick="editItem()">✏️ Edit</button>
        <button class="context-menu-item delete" onclick="deleteItem()">🗑️ Delete</button>
    </div>
    
    <!-- Calendar Tooltip -->
    <div id="calendar-tooltip" class="calendar-tooltip"></div>
    
    <!-- Date Tasks Modal -->
    <div id="date-tasks-modal" class="task-detail-modal">
        <div class="task-detail-content">
            <div class="modal-header">
                <div class="modal-title" id="date-tasks-title">Tasks for Date</div>
                <button class="close-btn" onclick="closeDateTasks()">×</button>
            </div>
            
            <div class="modal-section">
                <div id="date-tasks-list">
                    <!-- Tasks will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCoMfEYbPgkzAdcDIlCFUTMo0RTK107ukE",
            authDomain: "philaopersonal.firebaseapp.com",
            projectId: "philaopersonal",
            storageBucket: "philaopersonal.firebasestorage.app",
            messagingSenderId: "966795699161",
            appId: "1:966795699161:web:8ca9d0dfaa2f9e7fe42fc8",
            measurementId: "G-Y36VQMM6G3"
        };
        
        // Initialize Firebase
        let db, auth, isFirebaseAvailable = false;
        
        // Check if Firebase is loaded and initialize
        function initializeFirebase() {
            try {
                // Check if Firebase SDK is loaded
                if (typeof firebase === 'undefined') {
                    console.log('Firebase SDK not loaded - working in offline mode');
                    return false;
                }
                
                // Initialize Firebase with the config
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Configure Firestore settings for better offline support
                db.enablePersistence({ synchronizeTabs: true }).catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code == 'unimplemented') {
                        console.log('The current browser does not support offline persistence');
                    }
                });
                
                console.log('Firebase initialized successfully');
                return true;
            } catch (error) {
                console.log('Firebase initialization failed, working offline:', error.message);
                return false;
            }
        }
        
        isFirebaseAvailable = initializeFirebase();
        
        // Global state
        let currentMainTab = 'dashboard';
        let currentJobTab = null;
        let currentView = 'grid';
        let contextMenuTarget = null;
        let deleteTarget = null;
        let jobs = {};
        let notes = {};
        let currentDate = new Date();
        let noteFiles = [];
        let currentUser = null;
        let isAuthMode = 'signin';
        let syncStatus = 'offline';
        
        // Firebase is now configured with demo credentials
        console.log('🔥 Firebase configured and ready for cloud sync!');

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            loadAllData();
            renderCalendar();
            setupConnectionMonitoring();
        });
        
        // Connection monitoring
        function setupConnectionMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', () => {
                console.log('Connection restored');
                if (currentUser) {
                    updateSyncStatus('syncing');
                    processRetryQueue();
                    syncDataFromFirestore();
                }
            });
            
            window.addEventListener('offline', () => {
                console.log('Connection lost');
                updateSyncStatus('offline');
            });
            
            // Periodic connection check
            setInterval(() => {
                if (navigator.onLine && currentUser && isFirebaseAvailable) {
                    processRetryQueue();
                }
            }, 60000); // Check every minute
        }
        
        // App Initialization
        function initializeApp() {
            console.log('Initializing TaskFlow Pro with auto-sync');
            currentUser = { uid: 'anonymous_user', email: 'auto-sync@taskflow.pro' };
            updateUserInterface();
            
            if (isFirebaseAvailable) {
                console.log('Firebase available - enabling cloud sync');
                syncDataFromFirestore();
            } else {
                console.log('Firebase not available - working in offline mode');
                loadLocalData();
            }
        }
        
        function updateUserInterface() {
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');
            const syncBtn = document.getElementById('sync-btn');
            
            syncBtn.style.display = 'block';
            
            if (isFirebaseAvailable) {
                updateSyncStatus('synced');
            } else {
                updateSyncStatus('offline');
            }
        }
        
        function updateSyncStatus(status) {
            syncStatus = status;
            const indicator = document.getElementById('sync-indicator');
            const text = document.getElementById('sync-text');
            
            indicator.className = 'sync-indicator';
            
            switch (status) {
                case 'synced':
                    indicator.classList.add('synced');
                    text.textContent = 'Synced';
                    break;
                case 'syncing':
                    indicator.classList.add('syncing');
                    text.textContent = 'Syncing...';
                    break;
                case 'offline':
                    indicator.classList.add('offline');
                    text.textContent = 'Offline';
                    break;
            }
        }
        
        // Removed authentication functions - auto-sync enabled
        
        // Data Storage Functions
        async function saveToStorage(key, data) {
            try {
                // Always save to localStorage for offline access
                localStorage.setItem(`taskflow_${key}`, JSON.stringify(data));
                
                // If Firebase is available and user is signed in, also save to Firestore
                if (isFirebaseAvailable && currentUser) {
                    await saveToFirestore(key, data);
                }
            } catch (error) {
                console.error('Error saving data:', error);
                // Don't show alert for storage errors, just log them
                console.log('Data saved locally, cloud sync unavailable');
            }
        }
        
        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(`taskflow_${key}`);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                return null;
            }
        }
        
        async function saveToFirestore(key, data) {
            if (!isFirebaseAvailable || !db || !currentUser) {
                console.log('Firebase not available or no user signed in, skipping Firestore save');
                return;
            }
            
            try {
                console.log(`Saving ${key} to Firestore for user:`, currentUser.uid);
                updateSyncStatus('syncing');
                
                // Use merge: true to avoid overwriting other fields
                await db.collection('users').doc(currentUser.uid).collection('data').doc(key).set({
                    data: data,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    version: Date.now(),
                    deviceId: getDeviceId()
                }, { merge: true });
                
                console.log(`Successfully saved ${key} to Firestore`);
                updateSyncStatus('synced');
                
                // Set up real-time listener if not already set
                setupRealtimeSync(key);
                
            } catch (error) {
                console.error('Error saving to Firestore:', error);
                updateSyncStatus('offline');
                
                // Queue for retry when connection is restored
                queueForRetry(key, data);
            }
        }
        
        // Device ID for conflict resolution
        function getDeviceId() {
            let deviceId = localStorage.getItem('taskflow_device_id');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('taskflow_device_id', deviceId);
            }
            return deviceId;
        }
        
        // Queue failed saves for retry
        let retryQueue = [];
        function queueForRetry(key, data) {
            retryQueue.push({ key, data, timestamp: Date.now() });
            // Try to process queue every 30 seconds
            setTimeout(processRetryQueue, 30000);
        }
        
        async function processRetryQueue() {
            if (!isFirebaseAvailable || !db || !currentUser || retryQueue.length === 0) {
                return;
            }
            
            console.log('Processing retry queue:', retryQueue.length, 'items');
            const itemsToRetry = [...retryQueue];
            retryQueue = [];
            
            for (const item of itemsToRetry) {
                try {
                    await saveToFirestore(item.key, item.data);
                } catch (error) {
                    // Re-queue if still failing
                    retryQueue.push(item);
                }
            }
        }
        
        // Real-time sync listeners
        let syncListeners = {};
        function setupRealtimeSync(key) {
            if (!isFirebaseAvailable || !db || !currentUser || syncListeners[key]) {
                return;
            }
            
            console.log(`Setting up real-time sync for ${key}`);
            
            syncListeners[key] = db.collection('users')
                .doc(currentUser.uid)
                .collection('data')
                .doc(key)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const serverData = doc.data();
                        const localVersion = getLocalVersion(key);
                        
                        // Only update if server version is newer
                        if (serverData.version > localVersion) {
                            console.log(`Received newer ${key} data from server`);
                            updateLocalData(key, serverData.data, serverData.version);
                        }
                    }
                }, (error) => {
                    console.error(`Real-time sync error for ${key}:`, error);
                    updateSyncStatus('offline');
                });
        }
        
        function getLocalVersion(key) {
            const versionKey = `taskflow_${key}_version`;
            return parseInt(localStorage.getItem(versionKey) || '0');
        }
        
        function updateLocalData(key, data, version) {
            // Update local storage
            localStorage.setItem(`taskflow_${key}`, JSON.stringify(data));
            localStorage.setItem(`taskflow_${key}_version`, version.toString());
            
            // Update app state
            if (key === 'jobs') {
                jobs = data;
                renderJobs();
                updateDashboard();
                renderCalendar();
            } else if (key === 'notes') {
                notes = data;
                renderNotes();
            }
            
            updateSyncStatus('synced');
        }
        
        async function loadFromFirestore(key) {
            if (!isFirebaseAvailable || !db || !currentUser) return null;
            
            try {
                console.log(`Loading ${key} from Firestore for user:`, currentUser.uid);
                const doc = await db.collection('users').doc(currentUser.uid).collection('data').doc(key).get();
                
                if (doc.exists) {
                    console.log(`Successfully loaded ${key} from Firestore`);
                    return doc.data().data;
                } else {
                    console.log(`No ${key} data found in Firestore`);
                    return null;
                }
            } catch (error) {
                console.error('Error loading from Firestore:', error);
                return null;
            }
        }
        
        async function syncDataFromFirestore() {
            if (!isFirebaseAvailable || !db || !currentUser) {
                console.log('Firebase not available or no user signed in, loading local data');
                loadLocalData();
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                
                // Load jobs from Firestore with version checking
                const firestoreJobsDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('jobs').get();
                if (firestoreJobsDoc.exists) {
                    const serverData = firestoreJobsDoc.data();
                    const localVersion = getLocalVersion('jobs');
                    
                    if (serverData.version > localVersion) {
                        console.log('Updating jobs from server');
                        jobs = serverData.data || {};
                        localStorage.setItem('taskflow_jobs', JSON.stringify(jobs));
                        localStorage.setItem('taskflow_jobs_version', serverData.version.toString());
                    } else {
                        console.log('Local jobs data is current');
                        jobs = loadFromStorage('jobs') || {};
                    }
                } else {
                    // No server data, use local
                    jobs = loadFromStorage('jobs') || {};
                }
                
                // Load notes from Firestore with version checking
                const firestoreNotesDoc = await db.collection('users').doc(currentUser.uid).collection('data').doc('notes').get();
                if (firestoreNotesDoc.exists) {
                    const serverData = firestoreNotesDoc.data();
                    const localVersion = getLocalVersion('notes');
                    
                    if (serverData.version > localVersion) {
                        console.log('Updating notes from server');
                        notes = serverData.data || {};
                        localStorage.setItem('taskflow_notes', JSON.stringify(notes));
                        localStorage.setItem('taskflow_notes_version', serverData.version.toString());
                    } else {
                        console.log('Local notes data is current');
                        notes = loadFromStorage('notes') || {};
                    }
                } else {
                    // No server data, use local
                    notes = loadFromStorage('notes') || {};
                }
                
                // Set up real-time listeners
                setupRealtimeSync('jobs');
                setupRealtimeSync('notes');
                
                // Re-render everything with synced data
                renderJobs();
                renderNotes();
                updateDashboard();
                renderCalendar();
                
                updateSyncStatus('synced');
                
                // If we have local data but no server data, push local to server
                if (!firestoreJobsDoc.exists && Object.keys(jobs).length > 0) {
                    console.log('Pushing local jobs to server');
                    await saveToFirestore('jobs', jobs);
                }
                
                if (!firestoreNotesDoc.exists && Object.keys(notes).length > 0) {
                    console.log('Pushing local notes to server');
                    await saveToFirestore('notes', notes);
                }
                
            } catch (error) {
                console.error('Error syncing from Firestore:', error);
                updateSyncStatus('offline');
                // Fall back to local data
                loadLocalData();
            }
        }
        
        function loadLocalData() {
            try {
                jobs = loadFromStorage('jobs') || {};
                notes = loadFromStorage('notes') || {};
                renderJobs();
                renderNotes();
                updateDashboard();
            } catch (error) {
                console.error('Error loading local data:', error);
                renderEmptyStates();
            }
        }
        
        async function testSync() {
            if (!isFirebaseAvailable || !db) {
                alert('❌ Cloud sync is not available. The app works fully offline!\n\nYour data is safely stored in your browser.');
                return;
            }
            
            try {
                updateSyncStatus('syncing');
                console.log('Testing sync for anonymous user:', currentUser.uid);
                
                // Test saving a simple object
                const testData = {
                    test: true,
                    timestamp: new Date().toISOString(),
                    message: 'Auto-sync test successful'
                };
                
                await db.collection('users').doc(currentUser.uid).collection('data').doc('test').set({
                    data: testData,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('Test data saved to Firestore');
                
                // Try to read it back
                const doc = await db.collection('users').doc(currentUser.uid).collection('data').doc('test').get();
                
                if (doc.exists) {
                    console.log('Test data retrieved:', doc.data());
                    updateSyncStatus('synced');
                    alert('✅ Auto-sync test successful! Your data is syncing to the cloud automatically.');
                    
                    // Clean up test data
                    await db.collection('users').doc(currentUser.uid).collection('data').doc('test').delete();
                } else {
                    throw new Error('Could not retrieve test data');
                }
                
            } catch (error) {
                console.error('Sync test failed:', error);
                updateSyncStatus('offline');
                
                // More user-friendly error messages
                let errorMessage = '❌ Auto-sync test failed. ';
                if (error.code === 'permission-denied') {
                    errorMessage += 'Permission denied - the demo database may have restricted access.';
                } else if (error.code === 'unavailable') {
                    errorMessage += 'Service temporarily unavailable. Please try again later.';
                } else {
                    errorMessage += 'Please check your internet connection and try again.';
                }
                
                alert(errorMessage + '\n\nDon\'t worry - your data is safely stored locally and will auto-sync when the connection is restored.');
            }
        }
        
        async function clearAllData() {
            const confirmMessage = isFirebaseAvailable 
                ? 'Are you sure you want to clear all data? This will delete data from the cloud and cannot be undone.'
                : 'Are you sure you want to clear all local data? This cannot be undone.';
                
            if (confirm(confirmMessage)) {
                try {
                    // Clear local storage
                    localStorage.clear();
                    
                    // If Firebase is configured, also clear Firestore data
                    if (isFirebaseAvailable && db) {
                        updateSyncStatus('syncing');
                        await db.collection('users').doc(currentUser.uid).collection('data').doc('jobs').delete();
                        await db.collection('users').doc(currentUser.uid).collection('data').doc('notes').delete();
                        updateSyncStatus('synced');
                    }
                    
                    // Reset app state
                    jobs = {};
                    notes = {};
                    currentJobTab = null;
                    renderEmptyStates();
                    updateDashboard();
                    renderCalendar();
                    
                    alert('All data has been cleared!');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    alert('Error clearing data. Please try again.');
                }
            }
        }
        
        // Helper functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function generateReadableId(prefix, name) {
            const cleanName = name.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, '_')
                .substring(0, 20);
            const timestamp = Date.now().toString(36);
            return `${prefix}_${cleanName}_${timestamp}`;
        }
        
        function formatDate(date) {
            return date ? new Date(date).toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                year: 'numeric' 
            }) : 'No due date';
        }
        
        // Data loading functions
        function loadAllData() {
            // This function is now handled by the auth state change listener
            // Data loading is managed by initializeAuth() -> syncDataFromFirestore() or loadLocalData()
        }
        
        // Rendering functions
        function renderEmptyStates() {
            const jobTabsContainer = document.getElementById('job-tabs-container');
            jobTabsContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">💼</div>
                    <div>No jobs yet. Click "Add Job" to get started!</div>
                </div>
            `;
            
            const notesContainer = document.getElementById('notes-container');
            notesContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📝</div>
                    <div>No notes yet. Click "Add Note" to start taking notes!</div>
                </div>
            `;
        }
        
        function renderJobs() {
            const jobTabsContainer = document.getElementById('job-tabs-container');
            const jobContentContainer = document.getElementById('job-content-container');
            
            if (Object.keys(jobs).length === 0) {
                jobTabsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">💼</div>
                        <div>No jobs yet. Click "Add Job" to get started!</div>
                    </div>
                `;
                jobContentContainer.innerHTML = '';
                return;
            }
            
            let tabsHTML = '';
            let firstJobId = null;
            
            Object.values(jobs).forEach((job, index) => {
                if (index === 0) firstJobId = job.id;
                const isActive = currentJobTab === job.id || (!currentJobTab && index === 0);
                tabsHTML += `
                    <button class="job-tab ${isActive ? 'active' : ''}" onclick="switchJobTab('${job.id}')">
                        ${job.name}
                    </button>
                `;
            });
            
            jobTabsContainer.innerHTML = tabsHTML;
            
            if (!currentJobTab && firstJobId) {
                currentJobTab = firstJobId;
            }
            
            let contentHTML = '';
            Object.values(jobs).forEach(job => {
                const isActive = job.id === currentJobTab;
                contentHTML += renderJobContent(job, isActive);
            });
            
            jobContentContainer.innerHTML = contentHTML;
            initializeEventListeners();
        }
        
        function renderJobContent(job, isActive) {
            const projects = Object.values(job.projects || {});
            
            let projectsGridHTML = '';
            let projectsBannerHTML = '';
            
            if (projects.length === 0) {
                const emptyState = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div>No projects yet. Click "Add Project" to get started!</div>
                    </div>
                `;
                projectsGridHTML = emptyState;
                projectsBannerHTML = emptyState;
            } else {
                projects.forEach(project => {
                    projectsGridHTML += renderProjectCard(project, job.id);
                    projectsBannerHTML += renderProjectBanner(project, job.id);
                });
            }
            
            return `
                <div id="${job.id}-job" class="job-content ${isActive ? 'active' : ''}">
                    <div class="job-info" data-job-id="${job.id}">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div class="job-name" style="margin-bottom: 0;">${job.name}</div>
                            <button class="menu-btn" onclick="showContextMenu(event, this.closest('.job-info'), 'job')">⋮</button>
                        </div>
                        <div class="job-description">${job.description || ''}</div>
                        <div class="job-notes">
                            <div class="job-notes-title">📝 Job Notes</div>
                            <div>${job.notes || 'No notes added yet.'}</div>
                        </div>
                    </div>
                    
                    <div class="progress-header">
                        <div class="view-toggle">
                            <button class="view-btn ${currentView === 'grid' ? 'active' : ''}" onclick="switchView('grid')">Grid</button>
                            <button class="view-btn ${currentView === 'banner' ? 'active' : ''}" onclick="switchView('banner')">Banner</button>
                        </div>
                        <button class="add-btn" onclick="addProject()">+ Add Project</button>
                    </div>
                    
                    <div class="projects-grid" style="display: ${currentView === 'grid' ? 'grid' : 'none'}">
                        ${projectsGridHTML}
                    </div>
                    
                    <div class="projects-banner ${currentView === 'banner' ? 'active' : ''}">
                        ${projectsBannerHTML}
                    </div>
                </div>
            `;
        }
        
        function renderProjectCard(project, jobId) {
            const tasks = Object.values(project.tasks || {});
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const progress = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
            
            let tasksHTML = '';
            if (tasks.length === 0) {
                tasksHTML = `
                    <div class="empty-state" style="padding: 20px; text-align: center; color: #6b7280;">
                        <div>No tasks yet. Click "Add Task" to get started!</div>
                        <button class="add-subtask-btn" onclick="event.stopPropagation(); addTask();" style="margin-top: 12px;">+ Add Task</button>
                    </div>
                `;
            } else {
                tasks.forEach(task => {
                    tasksHTML += renderTaskCard(task, jobId, project.id);
                });
            }
            
            return `
                <div class="project-card priority-${project.priority || 'medium'}" data-project-id="${project.id}" data-job-id="${jobId}">
                    <div class="project-header">
                        <div class="project-title inline-editable" onclick="makeInlineEditable(this, 'project', 'title')">${project.title}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="project-status status-${project.status || 'active'} inline-editable" onclick="makeInlineDropdown(this, 'project', 'status')">${(project.status || 'active').charAt(0).toUpperCase() + (project.status || 'active').slice(1).replace('-', ' ')}</span>
                            <button class="menu-btn" onclick="showContextMenu(event, this.closest('.project-card'), 'project')">⋮</button>
                        </div>
                    </div>
                    <div class="project-meta">
                        <div class="project-meta-item">
                            <span>📅 Due: ${formatDate(project.dueDate)}</span>
                        </div>
                        <div class="project-meta-item">
                            <span class="priority-badge priority-${project.priority || 'medium'}">${(project.priority || 'medium').charAt(0).toUpperCase() + (project.priority || 'medium').slice(1)}</span>
                        </div>
                    </div>
                    <div class="project-description">${project.description || ''}</div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <div class="progress-text">${progress}% Complete</div>
                    <div class="tasks-banner" onclick="toggleTasks(this)">
                        <div class="tasks-banner-content">
                            <div class="tasks-info">
                                <span class="tasks-count">📋 ${tasks.length} Task${tasks.length !== 1 ? 's' : ''}</span>
                                <span class="tasks-progress">(${completedTasks} completed)</span>
                            </div>
                            <div class="tasks-controls">
                                <button class="add-subtask-btn" onclick="event.stopPropagation(); addTask();" style="padding: 4px 8px; font-size: 11px;">+ Add Task</button>
                                <span class="expand-icon">▼</span>
                            </div>
                        </div>
                        <div class="tasks-list">
                            ${tasksHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderProjectBanner(project, jobId) {
            const tasks = Object.values(project.tasks || {});
            const completedTasks = tasks.filter(task => task.status === 'completed').length;
            const progress = tasks.length > 0 ? Math.round((completedTasks / tasks.length) * 100) : 0;
            
            let tasksHTML = '';
            if (tasks.length === 0) {
                tasksHTML = `
                    <div class="empty-state" style="padding: 20px; text-align: center; color: #6b7280;">
                        <div>No tasks yet. Click "Add Task" to get started!</div>
                        <button class="add-subtask-btn" onclick="event.stopPropagation(); addTask();" style="margin-top: 12px;">+ Add Task</button>
                    </div>
                `;
            } else {
                tasks.forEach(task => {
                    tasksHTML += renderTaskCard(task, jobId, project.id);
                });
            }
            
            return `
                <div class="banner-card priority-${project.priority || 'medium'}" data-project-id="${project.id}" data-job-id="${jobId}">
                    <div class="banner-main">
                        <div class="banner-left">
                            <div class="project-header">
                                <div class="project-title">${project.title}</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span class="project-status status-${project.status || 'active'}">${(project.status || 'active').charAt(0).toUpperCase() + (project.status || 'active').slice(1).replace('-', ' ')}</span>
                                    <button class="menu-btn" onclick="showContextMenu(event, this.closest('.banner-card'), 'project')">⋮</button>
                                </div>
                            </div>
                            <div class="project-meta">
                                <div class="project-meta-item">
                                    <span>📅 Due: ${formatDate(project.dueDate)}</span>
                                </div>
                                <div class="project-meta-item">
                                    <span class="priority-badge priority-${project.priority || 'medium'}">${(project.priority || 'medium').charAt(0).toUpperCase() + (project.priority || 'medium').slice(1)}</span>
                                </div>
                            </div>
                            <div class="project-description">${project.description || ''}</div>
                        </div>
                        <div class="banner-right">
                            <div class="progress-text">${progress}% Complete</div>
                            <div class="progress-bar" style="width: 120px;">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    ${project.notes ? `<div class="project-notes">
                        <div class="project-notes-title">📝 Project Notes</div>
                        <div class="project-notes-content">${project.notes}</div>
                    </div>` : ''}
                    <div class="tasks-banner" onclick="toggleTasks(this)">
                        <div class="tasks-banner-content">
                            <div class="tasks-info">
                                <span class="tasks-count">📋 ${tasks.length} Task${tasks.length !== 1 ? 's' : ''}</span>
                                <span class="tasks-progress">(${completedTasks} completed)</span>
                            </div>
                            <div class="tasks-controls">
                                <button class="add-subtask-btn" onclick="event.stopPropagation(); addTask();" style="padding: 4px 8px; font-size: 11px;">+ Add Task</button>
                                <span class="expand-icon">▼</span>
                            </div>
                        </div>
                        <div class="tasks-list">
                            ${tasksHTML}
                        </div>
                    </div>
                </div>
            `;
        }
        
        function renderTaskCard(task, jobId, projectId) {
            return `
                <div class="task-card priority-${task.priority || 'medium'}" data-task-id="${task.id}" data-project-id="${projectId}" data-job-id="${jobId}">
                    <div class="task-header">
                        <div class="task-name-main">${task.name}</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="task-status-mini task-${task.status ? task.status.replace(' ', '-') : 'not-started'}">${task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('-', ' ') : 'Not Started'}</span>
                            <button class="menu-btn" onclick="showContextMenu(event, this.closest('.task-card'), 'task')">⋮</button>
                        </div>
                    </div>
                    <div class="task-meta-info">
                        <span>📅 Due: ${formatDate(task.dueDate)}</span>
                        <span class="priority-badge priority-${task.priority || 'medium'}">${(task.priority || 'medium').charAt(0).toUpperCase() + (task.priority || 'medium').slice(1)}</span>
                    </div>
                    ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                    <div class="task-actions">
                        <button class="details-btn" onclick="openTaskDetails('${task.id}', '${projectId}', '${jobId}')">View Details</button>
                    </div>
                </div>
            `;
        }
        
        function renderNotes() {
            const notesContainer = document.getElementById('notes-container');
            
            if (Object.keys(notes).length === 0) {
                notesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div>No notes yet. Click "Add Note" to start taking notes!</div>
                    </div>
                `;
                return;
            }
            
            let notesHTML = '';
            Object.values(notes)
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .forEach(note => {
                    let filesHTML = '';
                    if (note.files && note.files.length > 0) {
                        filesHTML = `
                            <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                                <div style="font-size: 12px; font-weight: 600; color: #6b7280; margin-bottom: 8px;">
                                    📎 ${note.files.length} attachment${note.files.length !== 1 ? 's' : ''}
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        `;
                        
                        note.files.forEach((file, index) => {
                            const fileIcon = getFileIcon(file.type);
                            const fileTypeClass = getFileTypeClass(file.type);
                            const canView = canViewFile(file.type);
                            const actionText = canView ? 'View' : 'Download';
                            const actionIcon = canView ? '👁️' : '⬇️';
                            
                            filesHTML += `
                                <div class="file-item" style="margin-bottom: 4px; padding: 8px; background: #f9fafb; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div class="file-info">
                                        <span class="file-icon ${fileTypeClass}">${fileIcon}</span>
                                        <div class="file-details">
                                            <div class="file-name" onclick="handleFileAction('${note.id}', ${index})">${file.name}</div>
                                            <div class="file-size">${formatFileSize(file.size)}</div>
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        <button class="file-action-btn ${canView ? 'view' : 'download'}" onclick="handleFileAction('${note.id}', ${index})" title="${actionText} file">
                                            ${actionIcon}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                        
                        filesHTML += `
                                </div>
                            </div>
                        `;
                    }
                    
                    notesHTML += `
                        <div class="note-card" data-note-id="${note.id}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div class="note-title" style="margin-bottom: 0;">${note.title}</div>
                                <button class="menu-btn" onclick="showContextMenu(event, this.closest('.note-card'), 'note')">⋮</button>
                            </div>
                            <div class="note-meta">${formatDate(note.createdAt)} • General</div>
                            <div class="note-content">${note.content}</div>
                            ${filesHTML}
                        </div>
                    `;
                });
            
            notesContainer.innerHTML = notesHTML;
            initializeEventListeners();
        }
        
        function updateDashboard() {
            const dueTodayContent = document.getElementById('due-today-content');
            const thisWeekContent = document.getElementById('this-week-content');
            
            const today = new Date();
            const weekFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            let dueTodayTasks = [];
            let thisWeekTasks = [];
            
            Object.values(jobs).forEach(job => {
                Object.values(job.projects || {}).forEach(project => {
                    Object.values(project.tasks || {}).forEach(task => {
                        if (task.dueDate) {
                            const dueDate = new Date(task.dueDate);
                            if (dueDate.toDateString() === today.toDateString()) {
                                dueTodayTasks.push({ ...task, jobName: job.name, projectTitle: project.title });
                            } else if (dueDate <= weekFromNow && dueDate > today) {
                                thisWeekTasks.push({ ...task, jobName: job.name, projectTitle: project.title });
                            }
                        }
                    });
                });
            });
            
            if (dueTodayTasks.length === 0) {
                dueTodayContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📅</div>
                        <div>No tasks due today. Great job staying on top of things!</div>
                    </div>
                `;
            } else {
                let dueTodayHTML = '';
                dueTodayTasks.forEach(task => {
                    const urgencyClass = task.priority === 'high' ? 'urgent' : task.priority === 'medium' ? 'medium' : '';
                    dueTodayHTML += `
                        <div class="task-item ${urgencyClass}">
                            <div class="task-title">${task.name}</div>
                            <div class="task-meta">${task.jobName} • ${task.projectTitle} • ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)} Priority</div>
                        </div>
                    `;
                });
                dueTodayContent.innerHTML = dueTodayHTML;
            }
            
            if (thisWeekTasks.length === 0) {
                thisWeekContent.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <div>No tasks due this week. Time to plan ahead!</div>
                    </div>
                `;
            } else {
                let thisWeekHTML = '';
                thisWeekTasks.forEach(task => {
                    const urgencyClass = task.priority === 'high' ? 'urgent' : task.priority === 'medium' ? 'medium' : '';
                    thisWeekHTML += `
                        <div class="task-item ${urgencyClass}">
                            <div class="task-title">${task.name}</div>
                            <div class="task-meta">${task.jobName} • ${task.projectTitle} • Due ${formatDate(task.dueDate)}</div>
                        </div>
                    `;
                });
                thisWeekContent.innerHTML = thisWeekHTML;
            }
        }
        
        // Event listener initialization
        function initializeEventListeners() {
            document.querySelectorAll('.job-info').forEach(element => {
                addDoubleClickListener(element, 'job');
            });
            
            document.querySelectorAll('.project-card, .banner-card').forEach(element => {
                addDoubleClickListener(element, 'project');
            });
            
            document.querySelectorAll('.task-card').forEach(element => {
                addDoubleClickListener(element, 'task');
            });
            
            document.querySelectorAll('.note-card').forEach(element => {
                addDoubleClickListener(element, 'note');
            });
        }
        
        function addDoubleClickListener(element, type) {
            element.addEventListener('dblclick', function(e) {
                if (e.target.classList.contains('menu-btn') || e.target.closest('.menu-btn')) {
                    return;
                }
                openEditModal(element, type);
            });
        }
        
        // Main tab switching
        function switchMainTab(tab) {
            currentMainTab = tab;
            
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }
        
        // Job tab switching
        function switchJobTab(jobId) {
            currentJobTab = jobId;
            
            document.querySelectorAll('.job-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.job-content').forEach(c => c.classList.remove('active'));
            document.getElementById(jobId + '-job').classList.add('active');
        }
        
        // View switching (Grid/Banner)
        function switchView(view) {
            currentView = view;
            
            const activeJobContent = document.querySelector('.job-content.active');
            if (activeJobContent) {
                activeJobContent.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                const gridView = activeJobContent.querySelector('.projects-grid');
                const bannerView = activeJobContent.querySelector('.projects-banner');
                
                if (view === 'grid') {
                    gridView.style.display = 'grid';
                    bannerView.classList.remove('active');
                } else if (view === 'banner') {
                    gridView.style.display = 'none';
                    bannerView.classList.add('active');
                }
            }
        }
        
        // Toggle dashboard sections
        function toggleDashboardSection(header) {
            const content = header.nextElementSibling;
            const icon = header.querySelector('.expand-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                icon.textContent = '▶';
            } else {
                content.classList.add('expanded');
                icon.textContent = '▼';
            }
        }
        
        // Toggle tasks list
        function toggleTasks(element) {
            const tasksList = element.querySelector('.tasks-list');
            const expandIcon = element.querySelector('.expand-icon');
            
            if (tasksList.classList.contains('expanded')) {
                tasksList.classList.remove('expanded');
                element.classList.remove('expanded');
            } else {
                tasksList.classList.add('expanded');
                element.classList.add('expanded');
            }
        }
        
        // Calendar functions
        function renderCalendar() {
            const monthNames = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            // Monday first, Sunday last
            const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            
            const monthDisplay = document.getElementById('calendar-month-display');
            const calendarGrid = document.getElementById('calendar-grid');
            
            monthDisplay.textContent = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            
            // Calculate start date for Monday-first week
            const dayOfWeek = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const mondayOffset = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Convert to Monday-first
            
            // Create the start date by going back to the Monday of the week containing the 1st
            const startDate = new Date(firstDay.getFullYear(), firstDay.getMonth(), firstDay.getDate() - mondayOffset);
            
            let calendarHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                calendarHTML += `<div class="calendar-day header">${day}</div>`;
            });
            
            // Add calendar days
            const today = new Date();
            for (let i = 0; i < 42; i++) {
                // Create a new date for each day to avoid reference issues
                const date = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + i);
                
                const isToday = date.toDateString() === today.toDateString();
                const isCurrentMonth = date.getMonth() === currentDate.getMonth();
                const tasksOnDate = getTasksOnDate(date);
                const hasTask = tasksOnDate.length > 0;
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasTask) classes += ' has-task';
                if (!isCurrentMonth) classes += ' other-month';
                
                // Use local date string to avoid timezone issues
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateString = `${year}-${month}-${day}`;
                
                const onMouseEnter = hasTask ? `onmouseenter="showCalendarTooltip(event, '${dateString}')"` : '';
                const onMouseLeave = hasTask ? `onmouseleave="hideCalendarTooltip()"` : '';
                const onClick = `onclick="showDateTasks('${dateString}')"`;
                
                calendarHTML += `<div class="${classes}" ${onMouseEnter} ${onMouseLeave} ${onClick}>${date.getDate()}</div>`;
            }
            
            calendarGrid.innerHTML = calendarHTML;
        }
        
        function hasTaskOnDate(date) {
            const dateString = date.toISOString().split('T')[0];
            
            for (const job of Object.values(jobs)) {
                for (const project of Object.values(job.projects || {})) {
                    for (const task of Object.values(project.tasks || {})) {
                        if (task.dueDate === dateString) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        function getTasksOnDate(date) {
            const dateString = date.toISOString().split('T')[0];
            const tasksOnDate = [];
            
            for (const job of Object.values(jobs)) {
                for (const project of Object.values(job.projects || {})) {
                    for (const task of Object.values(project.tasks || {})) {
                        if (task.dueDate === dateString) {
                            tasksOnDate.push({
                                ...task,
                                jobName: job.name,
                                projectTitle: project.title
                            });
                        }
                    }
                }
            }
            return tasksOnDate;
        }
        
        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }
        
        function showCalendarTooltip(event, dateString) {
            const tooltip = document.getElementById('calendar-tooltip');
            const date = new Date(dateString + 'T00:00:00');
            const tasksOnDate = getTasksOnDate(date);
            
            if (tasksOnDate.length === 0) return;
            
            let tooltipContent = `<strong>${formatDate(dateString)}</strong><br>`;
            tasksOnDate.forEach(task => {
                const priorityIcon = task.priority === 'high' ? '🔴' : task.priority === 'medium' ? '🟡' : '🟢';
                const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '🔄' : '⏳';
                tooltipContent += `${priorityIcon} ${statusIcon} ${task.name}<br><small>${task.jobName} • ${task.projectTitle}</small><br>`;
            });
            
            tooltip.innerHTML = tooltipContent;
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
            tooltip.classList.add('show');
        }
        
        function hideCalendarTooltip() {
            const tooltip = document.getElementById('calendar-tooltip');
            tooltip.classList.remove('show');
        }
        
        function showDateTasks(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            const tasksOnDate = getTasksOnDate(date);
            
            document.getElementById('date-tasks-title').textContent = `Tasks for ${formatDate(dateString)}`;
            
            let tasksHTML = '';
            
            if (tasksOnDate.length === 0) {
                tasksHTML = `
                    <div class="empty-state" style="padding: 40px 20px;">
                        <div class="empty-state-icon">📅</div>
                        <div>No tasks scheduled for this date</div>
                        <div style="font-size: 14px; color: #6b7280; margin-top: 8px;">Click "Add Task" in any project to schedule work for this day</div>
                    </div>
                `;
            } else {
                tasksOnDate.forEach(task => {
                    const priorityIcon = task.priority === 'high' ? '🔴' : task.priority === 'medium' ? '🟡' : '🟢';
                    const statusIcon = task.status === 'completed' ? '✅' : task.status === 'in-progress' ? '🔄' : '⏳';
                    const statusClass = task.status ? task.status.replace(' ', '-') : 'not-started';
                    
                    tasksHTML += `
                        <div class="task-card priority-${task.priority || 'medium'}" style="margin-bottom: 16px;">
                            <div class="task-header">
                                <div class="task-name-main">${priorityIcon} ${task.name}</div>
                                <span class="task-status-mini task-${statusClass}">${statusIcon} ${task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('-', ' ') : 'Not Started'}</span>
                            </div>
                            <div class="task-meta-info">
                                <span>💼 ${task.jobName}</span>
                                <span>📋 ${task.projectTitle}</span>
                            </div>
                            ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            document.getElementById('date-tasks-list').innerHTML = tasksHTML;
            document.getElementById('date-tasks-modal').classList.add('active');
        }
        
        function closeDateTasks() {
            document.getElementById('date-tasks-modal').classList.remove('active');
        }
        
        // Task detail functions
        function openTaskDetails(taskId, projectId, jobId) {
            const task = jobs[jobId]?.projects[projectId]?.tasks[taskId];
            if (!task) return;
            
            document.getElementById('modal-task-title').textContent = task.name;
            document.getElementById('modal-task-description').textContent = task.description || 'No description provided.';
            document.getElementById('modal-task-notes').textContent = task.notes || 'No notes added yet.';
            document.getElementById('modal-task-due').textContent = `📅 Due: ${formatDate(task.dueDate)}`;
            
            const statusBadge = document.getElementById('modal-task-status-badge');
            const statusText = task.status ? task.status.charAt(0).toUpperCase() + task.status.slice(1).replace('-', ' ') : 'Not Started';
            statusBadge.textContent = statusText;
            statusBadge.className = `task-status-mini task-${task.status ? task.status.replace(' ', '-') : 'not-started'}`;
            
            const priorityBadge = document.getElementById('modal-task-priority-badge');
            const priorityText = (task.priority || 'medium').charAt(0).toUpperCase() + (task.priority || 'medium').slice(1);
            priorityBadge.textContent = priorityText;
            priorityBadge.className = `priority-badge priority-${task.priority || 'medium'}`;
            
            document.getElementById('subtasks-container').innerHTML = '<div style="color: #6b7280; font-style: italic;">No sub-tasks yet.</div>';
            
            document.getElementById('task-detail-modal').classList.add('active');
        }
        
        function closeTaskDetails() {
            document.getElementById('task-detail-modal').classList.remove('active');
        }
        
        function attachFile() {
            alert('File attachment functionality - would open file picker to attach documents, images, or other files to this task');
        }
        
        function addSubtask() {
            document.querySelector('#add-task-modal .modal-title').textContent = 'Add New Sub-task';
            addTask();
        }
        
        // Add Task Modal Functions
        function addTask() {
            document.getElementById('task-modal-title').textContent = 'Add New Task';
            document.getElementById('task-save-btn').textContent = 'Create Task';
            document.getElementById('task-save-btn').onclick = saveNewTask;
            document.getElementById('add-task-modal').classList.add('active');
        }
        
        function closeAddTask() {
            document.getElementById('add-task-modal').classList.remove('active');
            document.getElementById('new-task-name').value = '';
            document.getElementById('new-task-description').value = '';
            document.getElementById('new-task-status').value = 'not-started';
            document.getElementById('new-task-priority').value = 'medium';
            document.getElementById('new-task-due').value = '';
            document.getElementById('new-task-notes').value = '';
        }
        
        function saveNewTask() {
            const name = document.getElementById('new-task-name').value;
            const description = document.getElementById('new-task-description').value;
            const status = document.getElementById('new-task-status').value;
            const priority = document.getElementById('new-task-priority').value;
            const due = document.getElementById('new-task-due').value;
            const notes = document.getElementById('new-task-notes').value;
            
            if (!name.trim()) {
                alert('Please enter a task name');
                return;
            }
            
            if (!currentJobTab) {
                alert('Please select a job first');
                return;
            }
            
            const currentJob = jobs[currentJobTab];
            const projectIds = Object.keys(currentJob.projects || {});
            
            if (projectIds.length === 0) {
                alert('Please create a project first');
                return;
            }
            
            const projectId = projectIds[0];
            const taskId = generateReadableId('task', name);
            const taskData = {
                id: taskId,
                name,
                description,
                status,
                priority,
                dueDate: due || null,
                notes,
                createdAt: new Date().toISOString()
            };
            
            if (!jobs[currentJobTab].projects[projectId].tasks) {
                jobs[currentJobTab].projects[projectId].tasks = {};
            }
            jobs[currentJobTab].projects[projectId].tasks[taskId] = taskData;
            
            saveToStorage('jobs', jobs);
            renderJobs();
            updateDashboard();
            renderCalendar();
            
            alert(`Task "${name}" created successfully!`);
            closeAddTask();
        }
        
        // Context Menu Functions
        function showContextMenu(event, target, type) {
            event.preventDefault();
            event.stopPropagation();
            
            contextMenuTarget = { element: target, type: type };
            const contextMenu = document.getElementById('context-menu');
            
            contextMenu.style.display = 'block';
            contextMenu.style.left = event.pageX + 'px';
            contextMenu.style.top = event.pageY + 'px';
            
            setTimeout(() => {
                document.addEventListener('click', hideContextMenu);
            }, 0);
        }
        
        function hideContextMenu() {
            document.getElementById('context-menu').style.display = 'none';
            document.removeEventListener('click', hideContextMenu);
            contextMenuTarget = null;
        }
        
        function editItem() {
            if (!contextMenuTarget) return;
            
            const element = contextMenuTarget.element;
            const type = contextMenuTarget.type;
            
            openEditModal(element, type);
            hideContextMenu();
        }
        
        function deleteItem() {
            if (!contextMenuTarget) return;
            
            const type = contextMenuTarget.type;
            let itemName = '';
            
            if (type === 'job') {
                itemName = contextMenuTarget.element.querySelector('.job-name').textContent;
            } else if (type === 'project') {
                itemName = contextMenuTarget.element.querySelector('.project-title').textContent;
            } else if (type === 'task') {
                itemName = contextMenuTarget.element.querySelector('.task-name-main').textContent;
            } else if (type === 'note') {
                itemName = contextMenuTarget.element.querySelector('.note-title').textContent;
            }
            
            deleteTarget = contextMenuTarget;
            document.getElementById('delete-message').textContent = `Are you sure you want to delete "${itemName}"?`;
            document.getElementById('delete-modal').classList.add('active');
            hideContextMenu();
        }
        
        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.remove('active');
            deleteTarget = null;
        }
        
        function confirmDelete() {
            if (!deleteTarget) return;
            
            const element = deleteTarget.element;
            const type = deleteTarget.type;
            
            if (type === 'job') {
                const jobId = element.dataset.jobId;
                delete jobs[jobId];
                
                const jobTab = document.querySelector(`[onclick="switchJobTab('${jobId}')"]`);
                const jobContent = document.getElementById(`${jobId}-job`);
                
                if (jobTab) jobTab.remove();
                if (jobContent) jobContent.remove();
                
                const remainingJobIds = Object.keys(jobs);
                if (remainingJobIds.length > 0) {
                    currentJobTab = remainingJobIds[0];
                    renderJobs();
                } else {
                    currentJobTab = null;
                    renderEmptyStates();
                }
                
            } else if (type === 'project') {
                const jobId = element.dataset.jobId;
                const projectId = element.dataset.projectId;
                delete jobs[jobId].projects[projectId];
                renderJobs();
                
            } else if (type === 'task') {
                const jobId = element.dataset.jobId;
                const projectId = element.dataset.projectId;
                const taskId = element.dataset.taskId;
                delete jobs[jobId].projects[projectId].tasks[taskId];
                renderJobs();
                
            } else if (type === 'note') {
                const noteId = element.dataset.noteId;
                delete notes[noteId];
                renderNotes();
            }
            
            saveToStorage('jobs', jobs);
            saveToStorage('notes', notes);
            updateDashboard();
            renderCalendar();
            
            alert(`${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully!`);
            closeDeleteModal();
        }
        
        // Open edit modal for items
        function openEditModal(element, type) {
            if (type === 'job') {
                const jobId = element.dataset.jobId;
                const job = jobs[jobId];
                
                document.getElementById('job-modal-title').textContent = 'Edit Job';
                document.getElementById('new-job-name').value = job.name || '';
                document.getElementById('new-job-description').value = job.description || '';
                document.getElementById('new-job-notes').value = job.notes || '';
                document.getElementById('job-save-btn').textContent = 'Save Changes';
                document.getElementById('job-save-btn').onclick = () => saveEditedJob(jobId);
                document.getElementById('add-job-modal').classList.add('active');
                
            } else if (type === 'project') {
                const jobId = element.dataset.jobId;
                const projectId = element.dataset.projectId;
                const project = jobs[jobId].projects[projectId];
                
                document.getElementById('project-modal-title').textContent = 'Edit Project';
                document.getElementById('new-project-title').value = project.title || '';
                document.getElementById('new-project-description').value = project.description || '';
                document.getElementById('new-project-status').value = project.status || 'active';
                document.getElementById('new-project-priority').value = project.priority || 'medium';
                document.getElementById('new-project-due').value = project.dueDate || '';
                document.getElementById('new-project-notes').value = project.notes || '';
                document.getElementById('project-save-btn').textContent = 'Save Changes';
                document.getElementById('project-save-btn').onclick = () => saveEditedProject(jobId, projectId);
                document.getElementById('add-project-modal').classList.add('active');
                
            } else if (type === 'task') {
                const jobId = element.dataset.jobId;
                const projectId = element.dataset.projectId;
                const taskId = element.dataset.taskId;
                const task = jobs[jobId].projects[projectId].tasks[taskId];
                
                document.getElementById('task-modal-title').textContent = 'Edit Task';
                document.getElementById('new-task-name').value = task.name || '';
                document.getElementById('new-task-description').value = task.description || '';
                document.getElementById('new-task-status').value = task.status || 'not-started';
                document.getElementById('new-task-priority').value = task.priority || 'medium';
                document.getElementById('new-task-due').value = task.dueDate || '';
                document.getElementById('new-task-notes').value = task.notes || '';
                document.getElementById('task-save-btn').textContent = 'Save Changes';
                document.getElementById('task-save-btn').onclick = () => saveEditedTask(jobId, projectId, taskId);
                document.getElementById('add-task-modal').classList.add('active');
                
            } else if (type === 'note') {
                const noteId = element.dataset.noteId;
                const note = notes[noteId];
                
                document.getElementById('note-modal-title').textContent = 'Edit Note';
                document.getElementById('new-note-title').value = note.title || '';
                document.getElementById('new-note-content').value = note.content || '';
                document.getElementById('note-save-btn').textContent = 'Save Changes';
                document.getElementById('note-save-btn').onclick = () => saveEditedNote(noteId);
                noteFiles = note.files || [];
                renderNoteFiles();
                document.getElementById('add-note-modal').classList.add('active');
            }
        }
        
        // Save edited items functions
        function saveEditedJob(jobId) {
            const name = document.getElementById('new-job-name').value;
            const description = document.getElementById('new-job-description').value;
            const notes = document.getElementById('new-job-notes').value;
            
            if (!name.trim()) {
                alert('Please enter a job name');
                return;
            }
            
            jobs[jobId].name = name;
            jobs[jobId].description = description;
            jobs[jobId].notes = notes;
            jobs[jobId].updatedAt = new Date().toISOString();
            
            saveToStorage('jobs', jobs);
            renderJobs();
            updateDashboard();
            
            alert(`Job "${name}" updated successfully!`);
            closeAddJob();
        }
        
        function saveEditedProject(jobId, projectId) {
            const title = document.getElementById('new-project-title').value;
            const description = document.getElementById('new-project-description').value;
            const status = document.getElementById('new-project-status').value;
            const priority = document.getElementById('new-project-priority').value;
            const due = document.getElementById('new-project-due').value;
            const notes = document.getElementById('new-project-notes').value;
            
            if (!title.trim()) {
                alert('Please enter a project title');
                return;
            }
            
            const project = jobs[jobId].projects[projectId];
            project.title = title;
            project.description = description;
            project.status = status;
            project.priority = priority;
            project.dueDate = due || null;
            project.notes = notes;
            project.updatedAt = new Date().toISOString();
            
            saveToStorage('jobs', jobs);
            renderJobs();
            updateDashboard();
            renderCalendar();
            
            alert(`Project "${title}" updated successfully!`);
            closeAddProject();
        }
        
        function saveEditedTask(jobId, projectId, taskId) {
            const name = document.getElementById('new-task-name').value;
            const description = document.getElementById('new-task-description').value;
            const status = document.getElementById('new-task-status').value;
            const priority = document.getElementById('new-task-priority').value;
            const due = document.getElementById('new-task-due').value;
            const notes = document.getElementById('new-task-notes').value;
            
            if (!name.trim()) {
                alert('Please enter a task name');
                return;
            }
            
            const task = jobs[jobId].projects[projectId].tasks[taskId];
            task.name = name;
            task.description = description;
            task.status = status;
            task.priority = priority;
            task.dueDate = due || null;
            task.notes = notes;
            task.updatedAt = new Date().toISOString();
            
            saveToStorage('jobs', jobs);
            renderJobs();
            updateDashboard();
            renderCalendar();
            
            alert(`Task "${name}" updated successfully!`);
            closeAddTask();
        }
        
        function saveEditedNote(noteId) {
            const title = document.getElementById('new-note-title').value;
            const content = document.getElementById('new-note-content').value;
            
            if (!title.trim()) {
                alert('Please enter a note title');
                return;
            }
            
            notes[noteId].title = title;
            notes[noteId].content = content;
            notes[noteId].files = noteFiles;
            notes[noteId].updatedAt = new Date().toISOString();
            
            saveToStorage('notes', notes);
            renderNotes();
            
            alert(`Note "${title}" updated successfully!`);
            closeAddNote();
        }
        
        // Job Modal Functions
        function addJob() {
            document.getElementById('job-modal-title').textContent = 'Add New Job';
            document.getElementById('job-save-btn').textContent = 'Create Job';
            document.getElementById('job-save-btn').onclick = saveNewJob;
            document.getElementById('add-job-modal').classList.add('active');
        }
        
        function closeAddJob() {
            document.getElementById('add-job-modal').classList.remove('active');
            document.getElementById('new-job-name').value = '';
            document.getElementById('new-job-description').value = '';
            document.getElementById('new-job-notes').value = '';
        }
        
        function saveNewJob() {
            const name = document.getElementById('new-job-name').value;
            const description = document.getElementById('new-job-description').value;
            const notes = document.getElementById('new-job-notes').value;
            
            if (!name.trim()) {
                alert('Please enter a job name');
                return;
            }
            
            const jobId = generateReadableId('job', name);
            const jobData = {
                id: jobId,
                name,
                description,
                notes,
                projects: {},
                createdAt: new Date().toISOString()
            };
            
            jobs[jobId] = jobData;
            currentJobTab = jobId;
            
            saveToStorage('jobs', jobs);
            renderJobs();
            updateDashboard();
            
            alert(`Job "${name}" created successfully!`);
            closeAddJob();
        }
        
        // Project Modal Functions
        function addProject() {
            if (!currentJobTab) {
                alert('Please select a job first');
                return;
            }
            
            document.getElementById('project-modal-title').textContent = 'Add New Project';
            document.getElementById('project-save-btn').textContent = 'Create Project';
            document.getElementById('project-save-btn').onclick = saveNewProject;
            document.getElementById('add-project-modal').classList.add('active');
        }
        
        function closeAddProject() {
            document.getElementById('add-project-modal').classList.remove('active');
            document.getElementById('new-project-title').value = '';
            document.getElementById('new-project-description').value = '';
            document.getElementById('new-project-status').value = 'active';
            document.getElementById('new-project-priority').value = 'medium';
            document.getElementById('new-project-due').value = '';
            document.getElementById('new-project-notes').value = '';
        }
        
        function saveNewProject() {
            const title = document.getElementById('new-project-title').value;
            const description = document.getElementById('new-project-description').value;
            const status = document.getElementById('new-project-status').value;
            const priority = document.getElementById('new-project-priority').value;
            const due = document.getElementById('new-project-due').value;
            const notes = document.getElementById('new-project-notes').value;
            
            if (!title.trim()) {
                alert('Please enter a project title');
                return;
            }
            
            if (!currentJobTab) {
                alert('Please select a job first');
                return;
            }
            
            const projectId = generateReadableId('project', title);
            const projectData = {
                id: projectId,
                title,
                description,
                status,
                priority,
                dueDate: due || null,
                notes,
                tasks: {},
                createdAt: new Date().toISOString()
            };
            
            if (!jobs[currentJobTab].projects) {
                jobs[currentJobTab].projects = {};
            }
            jobs[currentJobTab].projects[projectId] = projectData;
            
            saveToStorage('jobs', jobs);
            renderJobs();
            updateDashboard();
            renderCalendar();
            
            alert(`Project "${title}" created successfully!`);
            closeAddProject();
        }
        
        // Note Modal Functions
        function addNote() {
            document.getElementById('note-modal-title').textContent = 'Add New Note';
            document.getElementById('note-save-btn').textContent = 'Create Note';
            document.getElementById('note-save-btn').onclick = saveNewNote;
            noteFiles = [];
            renderNoteFiles();
            document.getElementById('add-note-modal').classList.add('active');
        }
        
        function closeAddNote() {
            document.getElementById('add-note-modal').classList.remove('active');
            document.getElementById('new-note-title').value = '';
            document.getElementById('new-note-content').value = '';
            noteFiles = [];
            renderNoteFiles();
        }
        
        function saveNewNote() {
            const title = document.getElementById('new-note-title').value;
            const content = document.getElementById('new-note-content').value;
            
            if (!title.trim()) {
                alert('Please enter a note title');
                return;
            }
            
            const noteId = generateReadableId('note', title);
            const noteData = {
                id: noteId,
                title,
                content,
                files: noteFiles,
                createdAt: new Date().toISOString()
            };
            
            notes[noteId] = noteData;
            
            saveToStorage('notes', notes);
            renderNotes();
            
            alert(`Note "${title}" created successfully!`);
            closeAddNote();
        }
        
        // File handling functions
        function triggerFileUpload() {
            document.getElementById('note-file-input').click();
        }
        
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            processFiles(files);
        }
        
        function handleFileDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.currentTarget;
            uploadArea.classList.remove('dragover');
            
            const files = Array.from(event.dataTransfer.files);
            processFiles(files);
        }
        
        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.add('dragover');
        }
        
        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('dragover');
        }
        
        function processFiles(files) {
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const fileData = {
                        name: file.name,
                        type: file.type,
                        size: file.size,
                        data: e.target.result,
                        uploadedAt: new Date().toISOString()
                    };
                    noteFiles.push(fileData);
                    renderNoteFiles();
                };
                reader.readAsDataURL(file);
            });
        }
        
        function renderNoteFiles() {
            const container = document.getElementById('note-uploaded-files');
            
            if (noteFiles.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let filesHTML = '';
            noteFiles.forEach((file, index) => {
                const fileIcon = getFileIcon(file.type);
                const fileTypeClass = getFileTypeClass(file.type);
                const canView = canViewFile(file.type);
                
                filesHTML += `
                    <div class="file-item">
                        <div class="file-info">
                            <span class="file-icon ${fileTypeClass}">${fileIcon}</span>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                            </div>
                        </div>
                        <div class="file-actions">
                            ${canView ? `<button class="file-action-btn view" onclick="previewFile(${index})" title="Preview file">👁️</button>` : ''}
                            <button class="file-action-btn download" onclick="downloadFile(${index})" title="Download file">⬇️</button>
                            <button class="file-action-btn delete" onclick="removeFile(${index})" title="Remove file">🗑️</button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = filesHTML;
        }
        
        function removeFile(index) {
            noteFiles.splice(index, 1);
            renderNoteFiles();
        }
        
        function previewFile(index) {
            const file = noteFiles[index];
            showFileViewer(file);
        }
        
        function downloadFile(index) {
            const file = noteFiles[index];
            const link = document.createElement('a');
            link.href = file.data;
            link.download = file.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function handleFileAction(noteId, fileIndex) {
            const note = notes[noteId];
            if (!note || !note.files || !note.files[fileIndex]) return;
            
            const file = note.files[fileIndex];
            
            if (canViewFile(file.type)) {
                showFileViewer(file);
            } else {
                // Download the file
                const link = document.createElement('a');
                link.href = file.data;
                link.download = file.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
        
        function showFileViewer(file) {
            document.getElementById('file-viewer-title').textContent = file.name;
            const mediaContainer = document.getElementById('file-viewer-media');
            
            if (file.type.startsWith('image/')) {
                mediaContainer.innerHTML = `<img src="${file.data}" alt="${file.name}" class="media-preview">`;
            } else if (file.type.startsWith('video/')) {
                mediaContainer.innerHTML = `<video controls class="media-preview"><source src="${file.data}" type="${file.type}">Your browser does not support video playback.</video>`;
            } else if (file.type.startsWith('audio/')) {
                mediaContainer.innerHTML = `<audio controls class="media-preview"><source src="${file.data}" type="${file.type}">Your browser does not support audio playback.</audio>`;
            } else {
                mediaContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <div style="font-size: 48px; margin-bottom: 16px;">${getFileIcon(file.type)}</div>
                        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">${file.name}</div>
                        <div style="font-size: 14px; margin-bottom: 16px;">File size: ${formatFileSize(file.size)}</div>
                        <button class="add-btn" onclick="downloadFileFromViewer('${file.data}', '${file.name}')">Download File</button>
                    </div>
                `;
            }
            
            document.getElementById('file-viewer-modal').classList.add('active');
        }
        
        function closeFileViewer() {
            document.getElementById('file-viewer-modal').classList.remove('active');
        }
        
        function downloadFileFromViewer(data, filename) {
            const link = document.createElement('a');
            link.href = data;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // File utility functions
        function getFileIcon(type) {
            if (type.startsWith('image/')) return '🖼️';
            if (type.startsWith('video/')) return '🎥';
            if (type.startsWith('audio/')) return '🎵';
            if (type.includes('pdf')) return '📄';
            if (type.includes('word') || type.includes('document')) return '📝';
            if (type.includes('excel') || type.includes('spreadsheet')) return '📊';
            if (type.includes('powerpoint') || type.includes('presentation')) return '📽️';
            if (type.includes('zip') || type.includes('rar') || type.includes('archive')) return '📦';
            if (type.includes('text')) return '📄';
            return '📎';
        }
        
        function getFileTypeClass(type) {
            if (type.startsWith('image/')) return 'file-type-image';
            if (type.startsWith('video/')) return 'file-type-video';
            if (type.startsWith('audio/')) return 'file-type-audio';
            if (type.includes('pdf') || type.includes('document') || type.includes('text')) return 'file-type-document';
            return 'file-type-other';
        }
        
        function canViewFile(type) {
            return type.startsWith('image/') || type.startsWith('video/') || type.startsWith('audio/');
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Inline editing functions
        function makeInlineEditable(element, itemType, field) {
            if (element.querySelector('.inline-input')) return; // Already editing
            
            const originalText = element.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalText;
            input.className = 'inline-input';
            
            element.innerHTML = '';
            element.appendChild(input);
            element.classList.add('editing');
            
            input.focus();
            input.select();
            
            function saveEdit() {
                const newValue = input.value.trim();
                if (newValue && newValue !== originalText) {
                    updateInlineField(element, itemType, field, newValue);
                }
                element.textContent = newValue || originalText;
                element.classList.remove('editing');
            }
            
            function cancelEdit() {
                element.textContent = originalText;
                element.classList.remove('editing');
            }
            
            input.addEventListener('blur', saveEdit);
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }
        
        function makeInlineDropdown(element, itemType, field) {
            if (element.querySelector('.inline-select')) return; // Already editing
            
            const originalText = element.textContent;
            let options = [];
            
            if (field === 'status') {
                if (itemType === 'project') {
                    options = [
                        { value: 'active', text: 'Active' },
                        { value: 'pending', text: 'Pending' },
                        { value: 'completed', text: 'Completed' },
                        { value: 'on-hold', text: 'On Hold' }
                    ];
                } else if (itemType === 'task') {
                    options = [
                        { value: 'not-started', text: 'Not Started' },
                        { value: 'in-progress', text: 'In Progress' },
                        { value: 'completed', text: 'Completed' },
                        { value: 'cancelled', text: 'Cancelled' }
                    ];
                }
            } else if (field === 'priority') {
                options = [
                    { value: 'low', text: 'Low' },
                    { value: 'medium', text: 'Medium' },
                    { value: 'high', text: 'High' }
                ];
            }
            
            const select = document.createElement('select');
            select.className = 'inline-select';
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option.value;
                optionElement.textContent = option.text;
                if (option.text.toLowerCase() === originalText.toLowerCase()) {
                    optionElement.selected = true;
                }
                select.appendChild(optionElement);
            });
            
            element.style.position = 'relative';
            element.appendChild(select);
            element.classList.add('editing');
            
            select.focus();
            
            function saveEdit() {
                const selectedOption = options.find(opt => opt.value === select.value);
                if (selectedOption && selectedOption.text !== originalText) {
                    updateInlineField(element, itemType, field, select.value);
                    element.textContent = selectedOption.text;
                    
                    // Update CSS classes for status
                    if (field === 'status') {
                        element.className = element.className.replace(/status-\w+/g, '');
                        element.classList.add(`status-${select.value}`);
                    }
                } else {
                    element.textContent = originalText;
                }
                
                element.classList.remove('editing');
                select.remove();
            }
            
            function cancelEdit() {
                element.textContent = originalText;
                element.classList.remove('editing');
                select.remove();
            }
            
            select.addEventListener('blur', saveEdit);
            select.addEventListener('change', saveEdit);
            select.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }
        
        function updateInlineField(element, itemType, field, newValue) {
            const container = element.closest(`[data-${itemType}-id]`);
            if (!container) return;
            
            if (itemType === 'project') {
                const jobId = container.dataset.jobId;
                const projectId = container.dataset.projectId;
                
                if (jobs[jobId] && jobs[jobId].projects[projectId]) {
                    jobs[jobId].projects[projectId][field] = newValue;
                    jobs[jobId].projects[projectId].updatedAt = new Date().toISOString();
                }
            } else if (itemType === 'task') {
                const jobId = container.dataset.jobId;
                const projectId = container.dataset.projectId;
                const taskId = container.dataset.taskId;
                
                if (jobs[jobId] && jobs[jobId].projects[projectId] && jobs[jobId].projects[projectId].tasks[taskId]) {
                    jobs[jobId].projects[projectId].tasks[taskId][field] = newValue;
                    jobs[jobId].projects[projectId].tasks[taskId].updatedAt = new Date().toISOString();
                }
            }
            
            saveToStorage('jobs', jobs);
            updateDashboard();
            renderCalendar();
        }
        
        // Click outside to close modals
        document.addEventListener('click', function(event) {
            // Close modals when clicking outside
            const modals = document.querySelectorAll('.task-detail-modal.active');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(event) {
            // Escape key to close modals
            if (event.key === 'Escape') {
                const activeModal = document.querySelector('.task-detail-modal.active');
                if (activeModal) {
                    activeModal.classList.remove('active');
                }
                
                const contextMenu = document.getElementById('context-menu');
                if (contextMenu.style.display === 'block') {
                    hideContextMenu();
                }
            }
            
            // Ctrl/Cmd + N for new items
            if ((event.ctrlKey || event.metaKey) && event.key === 'n') {
                event.preventDefault();
                
                if (currentMainTab === 'progress') {
                    if (Object.keys(jobs).length === 0) {
                        addJob();
                    } else {
                        addProject();
                    }
                } else if (currentMainTab === 'notes') {
                    addNote();
                }
            }
        });
        
        console.log('🚀 TaskFlow Pro fully loaded with all features!')
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;
	if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'978c116a119f8520',t:'MTc1NjgwNjI1OC4wMDAwMDA='};
		var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';
		document.getElementsByTagName('head')[0].appendChild(a);";
		b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');
		a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';
		a.style.visibility='hidden';document.body.appendChild(a);
	if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);
	else{var e=document.onreadystatechange||function(){};
	document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script>

<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js')
      .then(reg => console.log('SW registered', reg.scope))
      .catch(err => console.log('SW registration failed', err));
  });
}
</script>


</body>
</html>
